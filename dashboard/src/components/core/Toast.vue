<script setup lang="ts">
import { useToastStore } from "../../store/toast.store";
import {computed, ref, Ref, watch} from "vue";

const toastsTore = useToastStore();

let interval:  number | undefined = undefined;
let timeout: undefined | number = undefined;
const percent: Ref<number> = ref(0)
const message = computed(() => toastsTore.message);
const show = computed(() => toastsTore.show);
const delay = computed(() => toastsTore.delay);

watch(message, (newToast) => {
  if (show) {
    if (interval) {
      clearInterval(interval);
      interval = undefined;
    }
    if (timeout) {
      clearTimeout(timeout);
      timeout = undefined;
    }
    timeout = setTimeout(() => {
      close();
      timeout = undefined;
    }, delay.value);
    const startDate = Date.now();
    const futureDate = Date.now() + toastsTore.delay;
    interval = setInterval(() => {
      const date = Date.now();
      percent.value = ((date - startDate) * 100) / (futureDate - startDate);
      if (percent.value >= 100) {
        clearInterval(interval);
        interval = undefined;
      }
    }, 30);
  }
})

const close = () => {
  toastsTore.hideToast()
}
</script>

<template>
	<div
    v-show="show"
    class="fixed w-[400px] left-1/2 -ml-[200px] top-16 py-2 px-4 pb-4 bg-emerald-500 text-white"
  >
    <div class="font-semibold">{{ message }}</div>
    <button
      @click="close"
      class="absolute flex items-center justify-center right-2 top-2 w-[30px] h-[30px] rounded-full hover:bg-black/10 transition-colors"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-6 w-6"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M6 18L18 6M6 6l12 12"
        />
      </svg>
    </button>
    <!-- Progress -->
    <div>
      <div
        class="absolute left-0 bottom-0 right-0 h-[6px] bg-black/10"
        :style="{'width': `${percent}%`}"
      ></div>
    </div>
  </div>
</template>

<style scoped>

</style>